---
layout: article
tags: ThinkPHP
---

### 默认模板渲染规则改进

由于`fetch`方法和`view`函数的默认模板规则调整为操作方法的名称（不含操作后缀）转换为小写+下划线方式，而不是原来的直接把操作名称转小写。

举个例子，你的控制器操作方法名如果是`helloWorld`，渲染输出的时候会定位到 `helloworld.html`模板文件，而新版会自动定位到`hello_world.html`模板文件。

### 命名空间调整

| 5.0系统        | 5.1系统（可用“或者”）                    |
| :------------- | :--------------------------------------- |
| think\App      | think\facade\App （或者 App ）           |
| think\Cache    | think\facade\Cache （或者 Cache ）       |
| think\Config   | think\facade\Config （或者 Config ）     |
| think\Cookie   | think\facade\Cookie （或者 Cookie ）     |
| think\Debug    | think\facade\Debug （或者 Debug ）       |
| think\Env      | think\facade\Env （或者 Env ）           |
| think\Hook     | think\facade\Hook （或者 Hook ）         |
| think\Lang     | think\facade\Lang （或者 Lang ）         |
| think\Log      | think\facade\Log （或者 Log ）           |
| think\Request  | think\facade\Request （或者 Request ）   |
| think\Response | think\facade\Response （或者 Response ） |
| think\Route    | think\facade\Route （或者 Route ）       |
| think\Session  | think\facade\Session （或者 Session ）   |
| think\Url      | think\facade\Url （或者 Url ）           |
| think\Validate | think\facade\Validate （或者 Validate ） |
| think\View     | think\facade\View （或者 View ）         |

<!--more-->

### 数据库调整

- 取消了Query类的`getTableInfo`方法，可以用更加具体的`getTableFields`
  或者`getFieldsType`方法替代；
- 数据库查询后`5.1`不会清空查询条件；
- 取消了`select(false)` 用法，使用 `fetchSql()->select()` 替代；
- 如果使用了mysql的JSON查询语法，`user$.name` 需要改为 `user->name`；
- 改变了查询构造器的数组多字段批量查询，从原来的

```sql
where([
	'name'	=>	['like','think%'],
    'id'	=>	['>',0],
])
```

需要调整为

```sql
where([
	['name','like','think%'],
    ['id','>',0],
])
```

对于纯等于的数组条件则无需调整

```sql
where(['name'=>'think', 'type'=>1])
```

### 模型调整

为了确保模型的用法统一，对模型进行了一些调整，包括：

- 模型的数据集查询始终返回**数据集对象**而不再是数组；※
- 模型的数据表主键如果不是`id`，则必须设置模型的`pk`属性；
- 软删除trait引入更改为 `use think\model\concern\SoftDelete`；※
- 全局查询范围`base`方法中无需添加软删除条件；
- 聚合模型功能废除，使用关联模型配合关联自动写入功能替代，更灵活；※
- 模型的查询范围`scope`方法调用后只能使用数据库的查询方法；
- 取消模型的数据验证功能，请使用控制器验证或者路由验证替代；※

### 验证类调整

验证规则的错误信息定义不再支持规则和错误信息定义在一起，例如：

```php
namespace app\index\validate;

use think\Validate;

class User extends Validate
{
    protected $rule = [
        ['name','require|max:25','名称必须|名称最多不能超过25个字符'],
        ['age','number|between:1,120','年龄必须是数字|年龄必须在1~120之间'],
        ['email','email','邮箱格式错误']
    ];
}
```

需要调整为

```php
namespace app\index\validate;

use think\Validate;

class User extends Validate
{
    protected $rule = [
      'name'  => 'require|max:25',
      'age'   => 'number|between:1,120',
      'email' => 'email',
    ];

    protected $message = [
      'name.require' => '名称必须',
      'name.max'     => '名称最多不能超过25个字符',
      'age.number'   => '年龄必须是数字',
      'age.between'  => '年龄必须在1~120之间',
      'email'        => '邮箱格式错误',
    ];
}
```

### 官方扩展

`composer`扩展需升级到最新的`2.0`版本：

```
topthink/think-captcha
topthink/think-mongo
topthink/think-migration
topthink/think-testing
topthink/think-queue
```

### 助手函数

| 助手函数             | 描述                              |
| :------------------- | :-------------------------------- |
| **abort**            | **中断执行并发送HTTP状态码**      |
| action               | 调用控制器类的操作                |
| app                  | 快速获取容器中的实例 支持依赖注入 |
| behavior             | 执行某个行为                      |
| bind                 | 快速绑定对象实例                  |
| cache                | 缓存管理                          |
| call                 | 调用反射执行callable 支持依赖注入 |
| class_basename       | 获取类名(不包含命名空间)          |
| class_uses_recursive | 获取一个类里所有用到的trait       |
| **config**           | **获取和设置配置参数**            |
| container            | 获取容器对象实例                  |
| controller           | 实例化控制器                      |
| cookie               | Cookie管理                        |
| **db**               | **实例化数据库类**                |
| debug                | 调试时间和内存占用                |
| **dump**             | **浏览器友好的变量输出**          |
| env                  | 获取环境变量（`V5.1.3+`）         |
| **exception**        | **抛出异常处理**                  |
| halt                 | 变量调试输出并中断执行            |
| input                | 获取输入数据 支持默认值和过滤     |
| **json**             | **JSON数据输出**                  |
| **jsonp**            | **JSONP数据输出**                 |
| lang                 | 获取语言变量值                    |
| **model**            | **实例化Model**                   |
| **parse_name**       | **字符串命名风格转换**            |
| **redirect**         | **重定向输出**                    |
| **request**          | **实例化Request对象**             |
| **response**         | **实例化Response对象**            |
| route                | 注册路由规则（`V5.1.3+`）         |
| **session**          | **Session管理**                   |
| **token**            | **生成表单令牌输出**              |
| **trace**            | **记录日志信息**                  |
| trait_uses_recursive | 获取一个trait里所有引用到的trait  |
| url                  | Url生成                           |
| validate             | 实例化验证器                      |
| view                 | 渲染模板输出                      |
| widget               | 渲染输出Widget                    |
| xml                  | XML数据输出                       |

### 批量生成模块

如果需要批量生成多个模块的目录和文件，需要定义规则文件`build.php`并放入应用目录下面。

```php
return [
    // 定义demo模块的自动生成
    'demo'   => [
        '__file__'   => ['tags.php', 'user.php', 'hello.php'],
        '__dir__'    => ['config', 'controller', 'model', 'view'],
        'controller' => ['Index', 'Test', 'UserType'],
        'model'      => [],
        'view'       => ['index/index'],
    ],    
    
    // 定义test模块的自动生成
    'test'=>[
        '__dir__'   =>  ['config','controller','model','widget'],
        'controller'=>  ['Index','Test','UserType'],
        'model'     =>   ['User','UserType'],
        'view'      =>  ['index/index','index/test'],
    ],
 ];
```

定义好生成规则文件后，我们在命令行下面输入命令：

```shell
>php think build
```

### 几个注意点

- `Request`类不再需要`instance`方法，直接调用类的方法即可；
- 模板的变量输出默认添加了`htmlentities`安全过滤，如果你需要输出html内容的话，请使用`{$var|raw}`方式替换，并且`date`方法已经做了内部封装，无需再使用`###`变量替换；
- 不要用国内镜像！
