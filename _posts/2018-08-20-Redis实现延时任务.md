---
layout: article
tags: DelayedTask
---

#  Redis实现延时任务

### 创建Redis集群

在Redis3以上版本支持集群

<!--more-->

#### 安装ruby

```
apt-get install ruby
apt-get install rubygems
```

#### 创建redis.conf配置文件

由于redis是指定配置文件启动的，所以这里我们只需要指定多个配置文件就可以了。

例如：我要使用7000-7005这6个端口，我创建了6个文件夹分别用端口号命名，文件夹内放入redis.conf配置文件

文件配置：

```
port  7000  #端口号7000-7005
bind 127.0.0.1  
daemonize    yes  
pidfile  /var/run/redis_7000.pid # 文件名redis_7000-redis_7005
cluster-enabled  yes
cluster-config-file  nodes_7000.conf #文件名 nodes_7000-nodes_7005
cluster-node-timeout  15000
appendonly  yes
```



#### 创建sh启动脚本

```
../src/redis-server ./7000/redis.conf
../src/redis-server ./7001/redis.conf
../src/redis-server ./7002/redis.conf
../src/redis-server ./7003/redis.conf
../src/redis-server ./7004/redis.conf
../src/redis-server ./7005/redis.conf
```

#### 开启Redis服务

赋予脚本可执行权限

```
chmod a+x start-cluster.sh
```

执行脚本

[![paste image](http://cdn.lisongqian.cn/15347500416201hjtue96.png?imageslim)](http://cdn.lisongqian.cn/15347500416201hjtue96.png?imageslim)

#### 创建Redis集群

```
../src/redis-trib.rb create --replicas 1 127.0.0.1:7000 127.0.0.1:7001 127.0.0.1:7002 127.0.0.1:7003 127.0.0.1:7004 127.0.0.1:7005
```

- 这时可能会报错：

  原因是Ruby的redis接口没有安装，我们执行：

  ```
  gem install redis
  ```

  然后重新执行创建集群命令，出现下图所示，一切便大功告成。

[![paste image](http://cdn.lisongqian.cn/1534750476728e6097vmp.png?imageslim)](http://cdn.lisongqian.cn/1534750476728e6097vmp.png?imageslim)

### Redis实现延时任务

有序集合(Sorted Set)是Redis提供的一种数据结构，具有set和hash的特点。
其中每个元素都关联一个score，并以这个score来排序。
其内部实现用到了两个数据结构:hash table和 skip list(跳跃表)

[![paste image](http://cdn.lisongqian.cn/1534750526871wkai9gfm.png?imageslim)](http://cdn.lisongqian.cn/1534750526871wkai9gfm.png?imageslim)

#### skip list的特点

- 由很多层结构组成，level是通过一定的概率随机产生的
- 每一层都是一个有序的链表，默认是升序
- 最底层的链表包含所有元素
- 如果一个元素出现在Level i的链表中，则它在Level i之下的链表也都会出现
- 每个节点包含两个指针，一个指向同一链表中的下一个元素，一个指向下面一层的元素
- 插入和删除的时间复杂度是O(logn)，当达到了一定的数据规模之后，它的效率与红黑树差不多

#### 主要命令

- zadd:向Sorted Set中添加元素
- zrem:删除Sorted Set中的指定元素
- zrange:按照从小到大的顺序返回指定区间内的元素

#### 实现延迟队列

1. 将延迟任务加到Sorted Set，将延迟时间设为score
2. 启动一个线程不断判断Sorted Set中第一个元素的score是否大于当前时间
3. 如果大于，从Sorted Set中移除任务并添加到执行队列中
4. 如果小于，进行短暂休眠后重试**（会出现时间开销，在休眠时间中到达延时任务执行时间，影响到任务精准度）**

#### 实例操作

```
[root@VM_93_197_centos ~]# redis-cli
127.0.0.1:6379> zrange delayqueue 0 -1
(empty list or set)
127.0.0.1:6379> zadd dq 1 task1
(integer) 1
127.0.0.1:6379> zadd dq 2 task2
(integer) 1
127.0.0.1:6379> zadd dq 4 task4
(integer) 1
127.0.0.1:6379> zadd dq 3 task3
(integer) 1
127.0.0.1:6379> zrange dq 0 0
1) "task1"
127.0.0.1:6379> zrange dq 0 -1
1) "task1"
2) "task2"
3) "task3"
4) "task4"
127.0.0.1:6379> zrange dq 0 -1 withscores
1) "task1"
2) "1"
3) "task2"
4) "2"
5) "task3"
6) "3"
7) "task4"
8) "4"
```

#### 分布式操作

```
root@slave1:/www/server/redis/redis-cluster# ../src/redis-cli -h 127.0.0.1 -c -p 7000
127.0.0.1:7000> zadd dq 1 task1
-> Redirected to slot [10584] located at 127.0.0.1:7001
(integer) 1
127.0.0.1:7001> zrange dq 0 -1
1) "task1"
```

简单说明：

1. redis cluster本身集群方案，客户端可以任一连接一个节点
2. redis-trib.rb脚本为集群的管理工具，比如自动添加节点，规划槽位，迁移数据等一系列操作（ruby语言）
3. 每个节点都和N-1个节点通信，所以要维护好这个集群架构的每个节点信息，不然会导致整个集群不可工作

#### 优点：

- 实现简单
- 任务可管理（可删除、修改任务）

**缺点：**

- 需要有短轮询线程不断判断第一个元素是否过期，造成CPU空耗
- 分布式场景中，容易引起多个节点读取到相同任务

#### REFERENCES

- [Ubantu之redis集群配置](https://www.cnblogs.com/xiong63/p/7017488.html)
- [Redis集群架构](http://rdc.hundsun.com/portal/article/669.html)
- [Redis分布式集群架构](https://blog.csdn.net/agzhchren/article/details/53727040)